name: tests
on: push

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        python-version: [3.9]
        variant:
          - {os: ubuntu-latest, generator: clang, arch: x64, config: Release} 

    runs-on: ${{ matrix.variant.os }}
    name: ${{ matrix.variant.os }} / ${{ matrix.variant.generator }} / ${{ matrix.variant.arch }} / ${{ matrix.python-version }}
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: '0'
    
    - name: Show GitHub context
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: echo "$GITHUB_CONTEXT"

    - name: Run test coverage
      id: get_coverage
      run: |
        set -x
        commit=$(git rev-parse HEAD)
        echo "commit=${commit}" >> $GITHUB_OUTPUT
        include_tests=$(git diff ${{ github.event.before }} ${{ github.event.after }} --compact-summary | egrep  --count '^ tests/' || true)
        echo "include_tests=1" >> $GITHUB_OUTPUT
        include_docs=$(git diff ${{ github.event.before }} ${{ github.event.after }} --compact-summary | egrep  --count '^ docs/' || true)
        echo "include_docs=0" >> $GITHUB_OUTPUT
        
    - uses: mondeja/remove-labels-gh-action@v1
      if: ${{ steps.get_coverage.outputs.include_docs }} == 0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        labels: documentation

    - uses: mondeja/remove-labels-gh-action@v1
      if: ${{ steps.get_coverage.outputs.include_tests }} == 0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        labels: automation/ci

    - uses: actions-ecosystem/action-add-labels@v1
      if: ${{ steps.get_coverage.outputs.include_docs }} > 0
      with:
        labels: documentation

    - uses: actions-ecosystem/action-add-labels@v1
      if: ${{ steps.get_coverage.outputs.include_tests }} > 0
      with:
        labels: automation/ci
