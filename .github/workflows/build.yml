name: tests
on: push

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        python-version: [3.9]
        variant:
          - {os: windows-latest, generator: msvc, arch: x64, config: Release} 
          - {os: ubuntu-latest, generator: clang, arch: x64, config: Release} 
          - {os: macos-latest, generator: clang, arch: x64, config: Release} 

    runs-on: ${{ matrix.variant.os }}
    name: ${{ matrix.variant.os }} / ${{ matrix.variant.generator }} / ${{ matrix.variant.arch }} / ${{ matrix.python-version }}
    steps:
    - uses: actions/checkout@v3

    - name: Run test coverage
      id: get_coverage
      run: |
        commit=$(git rev-parse HEAD)
        include_tests=$(git diff ${env.GITHUB_SHA} ${github.event.pull_request.head.sha} --compact-summary | egrep --count '^ tests/')
        include_docs=$(git diff ${env.GITHUB_SHA} ${github.event.pull_request.head.sha} --compact-summary | egrep --count '^ docs/')
        echo "commit=${commit}" >> $GITHUB_OUTPUT
        echo "include_tests=1" >> $GITHUB_OUTPUT
        echo "include_docs=0" >> $GITHUB_OUTPUT
        
    - uses: mondeja/remove-labels-gh-action@v1
      if: ${{ steps.get_coverage.outputs.include_docs }} == 0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        labels: documentation

    - uses: mondeja/remove-labels-gh-action@v1
      if: ${{ steps.get_coverage.outputs.include_tests }} == 0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        labels: automation/ci

    - uses: actions-ecosystem/action-add-labels@v1
      if: ${{ steps.get_coverage.outputs.include_docs }} > 0
      with:
        labels: documentation

    - uses: actions-ecosystem/action-add-labels@v1
      if: ${{ steps.get_coverage.outputs.include_tests }} > 0
      with:
        labels: automation/ci
